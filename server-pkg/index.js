var h=Object.create;var E=Object.defineProperty;var C=Object.getOwnPropertyDescriptor;var L=Object.getOwnPropertyNames;var O=Object.getPrototypeOf,F=Object.prototype.hasOwnProperty;var A=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);var j=(e,t,i,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of L(t))!F.call(e,n)&&n!==i&&E(e,n,{get:()=>t[n],enumerable:!(r=C(t,n))||r.enumerable});return e};var J=(e,t,i)=>(i=e!=null?h(O(e)):{},j(t||!e||!e.__esModule?E(i,"default",{value:e,enumerable:!0}):i,e));var M=A((B,x)=>{var d=null;typeof WebSocket<"u"?d=WebSocket:typeof MozWebSocket<"u"?d=MozWebSocket:typeof global<"u"?d=global.WebSocket||global.MozWebSocket:typeof window<"u"?d=window.WebSocket||window.MozWebSocket:typeof self<"u"&&(d=self.WebSocket||self.MozWebSocket);x.exports=d});var c=class extends Error{},u=class extends c{},w=class extends c{};var I=J(M());async function k(e){if(!e)throw new Error("No URL provided. Did you forget to configure the client?");let t=new I.default(e);return new Promise((i,r)=>{t.addEventListener("open",()=>{i(t)}),t.addEventListener("error",n=>{r(n)})})}async function m(e,t){e.send(JSON.stringify(t))}function W(e,t,i){return new Promise((r,n)=>{let o=i!=null?setTimeout(()=>{n(new u("Timeout waiting for function result exceeded"))},i):null,a=y=>{try{let f=JSON.parse(y.data.toString());if(!K(f,t))return;if(clearTimeout(o),f.error){let z=f.error.name==="FlayerError"?c:Error,N=new z(f.error.message);n(N)}else r(f.data);e.removeEventListener("message",a)}catch{}};e.addEventListener("message",a),e.addEventListener("close",()=>{e.removeEventListener("message",a),n(new c("Client disconnected"))})})}function K(e,t){return Object.keys(t).every(i=>e?.[i]===t[i])}var s={date:"@Date",map:"@Map",set:"@Set",bigInt:"@BigInt",regExp:"@RegExp",function:"@Function",special:"@SpecialValue",error:"@Error"};function R(e){return Array.isArray(e)&&e.length===2&&Object.values(s).includes(e[0])}var T=0;function D(e,t){let i=T++,r=async n=>{let o=JSON.parse(n.data);if(o.type!=="callback"||o.id!==i)return;let a=l(o.args,e);await t(...a)};return e.addEventListener("message",r),e.addEventListener("close",()=>{e.removeEventListener("message",r)}),i}function p(e,t){try{return JSON.stringify(e,(r,n)=>{if(typeof n=="object"&&!(n instanceof Map)&&!(n instanceof Set)&&!(n instanceof RegExp)&&n!=null){let o=Array.isArray(n)?[...n]:{...n};for(let a in n)n[a]instanceof Date&&(o[a]=[s.date,n[a].toISOString()]);return o}if(n instanceof Map){let o=p(Array.from(n.entries()),t);return[s.map,o]}if(n instanceof Set){let o=p(Array.from(n.values()),t);return[s.set,o]}if(n instanceof RegExp)return[s.regExp,[n.source,n.flags]];if(n instanceof Error)return[s.error,n.message];if(typeof n=="bigint")return[s.bigInt,n.toString()];if(typeof n=="function"){let o=D(t,n);return[s.function,o]}return typeof n=="number"&&isNaN(n)?[s.special,"NaN"]:n===1/0?[s.special,"Infinity"]:n===-1/0?[s.special,"-Infinity"]:n})}catch(i){throw new S(i.message)}}function l(e,t){if(e==null)return null;try{return JSON.parse(e,(i,r)=>{if(!R(r))return r;let[n,o]=r;switch(n){case s.date:return new Date(o);case s.map:return new Map(l(o,t));case s.set:return new Set(l(o,t));case s.regExp:return new RegExp(o[0],o[1]);case s.error:return new Error(o);case s.bigInt:return BigInt(o);case s.function:let a=(...y)=>{m(t,{type:"callback",id:o,args:p(y,t)})};return Object.defineProperty(a,"name",{value:i,writable:!1}),a;case s.special:switch(o){case"NaN":return NaN;case"Infinity":return 1/0;case"-Infinity":return-1/0;default:return r}default:return r}})}catch(i){throw console.error(i),new Error("serialization_error")}}var S=class extends Error{constructor(t){super(`Serialization failed: ${t}`)}};function b(e){return window.flayer[e]}function g(e,t){window.flayer||(window.flayer={invocationId:0,ws:null,config:null}),window.flayer[e]=t}async function Y(e,t,i){let r=b("ws");if(!r||r.readyState!==r.OPEN){let y=b("config");if(!y)throw new c("Client not configured");try{r=await k(y.url),g("ws",r)}catch{throw new w("Error connecting to server")}}let n=b("invocationId");g("invocationId",n+1);let o=p(i,r);m(r,{type:"invocation",id:n,modulePath:e,functionName:t,data:o});let a=await W(r,{type:"result",id:n});return l(a,r)}async function Z(e){g("config",e),g("ws",await k(e.url))}async function v(){b("ws").close(),g("ws",null)}export{Z as configure,v as disconnect,Y as executeFlayerFunction};
//# sourceMappingURL=index.js.map
